{{- $providerKind := $.Values.global.provider.kind | default "" }}
apiVersion: v1
kind: ConfigMapList
items:
## Dashboards (always deployed)
{{- range $path, $_ := $.Files.Glob "dashboards/**/*.json" }}
{{- if not (hasPrefix "dashboards/provider/" $path) }}
{{- $dashboardName := regexReplaceAll "(^.*/)(.*)\\.json$" $path "${2}" }}
{{- $org := regexReplaceAll "^dashboards/([^/]+)/.*$" $path "${1}" }}
{{- $folder := regexReplaceAll "^dashboards/[^/]+/(.*)/[^/]+\\.json$" $path "${1}" }}
- apiVersion: v1
  kind: ConfigMap
  metadata:
    annotations:
      observability.giantswarm.io/organization: {{ $org | quote }}
      observability.giantswarm.io/folder: {{ $folder | quote }}
    labels:
      {{- include "labels.common" $ | nindent 6 }}
    name: {{ printf "grafana-%s-%s-dashboard" ($folder | sha256sum | trunc 8) $dashboardName | trunc 63 | trimSuffix "-" }}
    namespace: {{ $.Values.global.namespace }}
  data:
    {{ $dashboardName }}.json: {{ $.Files.Get $path | toJson }}
{{- end }}
{{- end }}
## Provider-specific dashboards (only deployed when provider matches)
{{- if $providerKind }}
{{- range $path, $_ := $.Files.Glob (printf "dashboards/provider/%s/**/*.json" $providerKind) }}
{{- $dashboardName := regexReplaceAll "(^.*/)(.*)\\.json$" $path "${2}" }}
{{- $providerPrefix := printf "dashboards/provider/%s/" $providerKind }}
{{- $relativePath := trimPrefix $providerPrefix $path }}
{{- $org := regexReplaceAll "^([^/]+)/.*$" $relativePath "${1}" }}
{{- $folder := regexReplaceAll "^[^/]+/(.*)/[^/]+\\.json$" $relativePath "${1}" }}
- apiVersion: v1
  kind: ConfigMap
  metadata:
    annotations:
      observability.giantswarm.io/organization: {{ $org | quote }}
      observability.giantswarm.io/folder: {{ $folder | quote }}
    labels:
      {{- include "labels.common" $ | nindent 6 }}
    name: {{ printf "grafana-%s-%s-%s-dashboard" $providerKind ($folder | sha256sum | trunc 8) $dashboardName | trunc 63 | trimSuffix "-" }}
    namespace: {{ $.Values.global.namespace }}
  data:
    {{ $dashboardName }}.json: {{ $.Files.Get $path | toJson }}
{{- end }}
{{- end }}
